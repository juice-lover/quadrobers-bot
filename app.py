# --- app.py ---
# --- –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ---

from config import ConfigBotClass
import telebot

from flask import Flask, request
from modules import database


# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = telebot.TeleBot(ConfigBotClass.API_TOKEN_TELEGRAM, threaded=False)
app = Flask(__name__)


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@bot.message_handler(commands=['start'])
def start(message):
    telegram_id = message.from_user.id  # –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram

    # –ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
    user_already_exists = database.add_user_to_db(telegram_id)

    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∏–∫–µ—Ä–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
    bot.send_sticker(message.chat.id, ConfigBotClass.WELCOME_START_STICKER)

    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    message_text = (
        "–ü—Ä–∏–≤–µ—Ç, –∫–≤–∞–¥—Ä–æ–±–µ—Ä! üêæ\n\n"
        "–¢—ã –Ω–∞—à—ë–ª —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞, —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –∂–∏–≤—ë—Ç –Ω–∞ —á–µ—Ç–≤–µ—Ä–µ–Ω—å–∫–∞—Ö –∏ –ª—é–±–∏—Ç –∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤–∞–¥–∫–∏ –∂–∏–≤–æ—Ç–Ω—ã—Ö! üöÄ\n\n"
        "–ú—ã –≥–æ—Ç–æ–≤–∏–º –¥–ª—è —Ç–µ–±—è —Ü–µ–ª—ã–π –Ω–∞–±–æ—Ä —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç —É–ª—É—á—à–∏—Ç—å —Ç–≤–æ–∏ –Ω–∞–≤—ã–∫–∏, –Ω–∞–π—Ç–∏ –Ω–æ–≤—ã—Ö –¥—Ä—É–∑–µ–π –∏ —Å–¥–µ–ª–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –µ—â—ë –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ. –ù–æ –ø–æ–∫–∞ —ç—Ç–æ –Ω–µ–±–æ–ª—å—à–æ–π —Å–µ–∫—Ä–µ—Ç... üòâ\n\n"
        "–°–æ–≤—Å–µ–º —Å–∫–æ—Ä–æ —Ç—ã —Å–º–æ–∂–µ—à—å –∏—Å–ø—ã—Ç–∞—Ç—å –Ω–∞ —Å–µ–±–µ –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞! –ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Å—è, –æ—Å—Ç–∞–≤–∞–π—Å—è —Å –Ω–∞–º–∏ –∏ –±—É–¥—å –≥–æ—Ç–æ–≤ –∫ –ø–µ—Ä–≤—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º. –≠—Ç–æ –±—É–¥–µ—Ç –∫—Ä—É—Ç–æ! üê∫‚ú®"
    )

    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    bot.reply_to(message, message_text)


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±—Ö—É–∫–∞ –æ—Ç Telegram
@app.route(f'/webhook/{ConfigBotClass.WEBHOOK_SECRET_PATH}', methods=['POST'])
def webhook():
    update = telebot.types.Update.de_json(request.stream.read().decode('utf-8'))
    bot.process_new_updates([update])
    print("WebHook –ø–æ–ª—É—á–µ–Ω")  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
    return 'ok', 200


@bot.message_handler(commands=['a'])
def admin_panel(message):
    telegram_id = message.from_user.id  # –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    if telegram_id == ConfigBotClass.TELEGRAM_ID_ADMIN:
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            number_of_users = database.get_number_of_users()

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∞
            text_message = (f"–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å\n\n"
                            f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {number_of_users}")

            bot.reply_to(message, text_message)

        except Exception as e:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫
            bot.reply_to(message, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.")
            print(f"–û—à–∏–±–∫–∞ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏: {e}")
